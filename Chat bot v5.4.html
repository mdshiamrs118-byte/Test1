<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Royale | Sequential TTS</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"/>

    <style>
        :root {
            --royal-bg: #0f172a; --gold: #e2b13c; --glass: rgba(30, 41, 59, 0.7);
            --text-main: #f8fafc; --ai-bubble: linear-gradient(135deg, #1e293b 0%, #334155 100%);
            --user-bubble: linear-gradient(135deg, #b8860b 0%, #e2b13c 100%);
        }

        body {
            font-family: 'Inter', sans-serif; background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            color: var(--text-main); display: flex; justify-content: center; align-items: center;
            height: 100vh; margin: 0; overflow: hidden;
        }

        #chat-container {
            width: 95%; max-width: 600px; height: 85vh; background: var(--glass); backdrop-filter: blur(12px);
            border: 1px solid rgba(226, 177, 60, 0.3); border-radius: 24px; display: flex; flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); position: relative;
        }

        header { padding: 20px 25px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(226, 177, 60, 0.2); }
        .logo-area { display: flex; align-items: center; gap: 10px; font-weight: 600; color: var(--gold); }
        .menu-btn { background: rgba(255,255,255,0.05); border: none; color: var(--gold); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }

        #settings-panel { position: absolute; top: 80px; right: 20px; background: #1e293b; border: 1px solid var(--gold); padding: 20px; border-radius: 15px; display: none; z-index: 1000; width: 280px; }
        #settings-panel input, #settings-panel select { width: 100%; margin: 10px 0; padding: 12px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; }

        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .message-wrapper { display: flex; flex-direction: column; max-width: 85%; }
        .user-wrapper { align-self: flex-end; }
        .ai-wrapper { align-self: flex-start; }
        .message { padding: 14px 18px; border-radius: 18px; line-height: 1.6; font-size: 15px; }
        .user { background: var(--user-bubble); color: #000; font-weight: 500; border-bottom-right-radius: 4px; }
        .ai { background: var(--ai-bubble); color: white; border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        
        .status-msg { font-size: 12px; color: var(--gold); margin-left: 10px; font-style: italic; display: none; }
        .error-box { background: #450a0a; border: 1px solid #f87171; color: #fecaca; padding: 12px; border-radius: 10px; font-size: 13px; align-self: center; max-width: 90%; margin: 10px 0; }

        .action-btns { display: flex; gap: 8px; margin-top: 5px; }
        .icon-btn { background: none; border: none; color: #94a3b8; cursor: pointer; padding: 8px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: 0.2s; }
        .icon-btn:hover { color: var(--gold); background: rgba(255,255,255,0.1); }
        .icon-btn.speaking { color: var(--gold); animation: pulse 1s infinite; }

        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.4; } 100% { opacity: 1; } }

        .input-area { padding: 20px; display: flex; gap: 12px; background: rgba(0,0,0,0.2); border-bottom-left-radius: 24px; border-bottom-right-radius: 24px; }
        #user-input { flex: 1; padding: 14px 20px; border-radius: 30px; border: 1px solid #334155; background: #0f172a; color: white; outline: none; }
        #send-btn { background: var(--gold); border: none; width: 48px; height: 48px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
    </style>
</head>
<body>

<div id="chat-container">
    <header>
        <div class="logo-area"><i data-lucide="crown"></i><span>GEMINI ROYALE</span></div>
        <div id="ai-status" class="status-msg">AI is thinking...</div>
        <button class="menu-btn" onclick="toggleSettings()"><i data-lucide="settings"></i></button>
    </header>

    <div id="settings-panel">
        <h3 style="margin:0 0 10px 0; color:var(--gold);">Palace Settings</h3>
        <input type="password" id="api-key" placeholder="Enter Gemini API Key">
        <select id="model-select">
            <option value="gemini-2.5-flash">Gemini 2.5 Flash</option>
            <option value="gemini-3-flash-preview">Gemini 3 Flash</option>
        </select>
        <button onclick="saveSettings()" style="width:100%; background:var(--gold); padding:12px; border:none; border-radius:8px; cursor:pointer; font-weight:600;">SAVE CONFIG</button>
    </div>

    <div id="messages"></div>

    <div class="input-area">
        <input type="text" id="user-input" placeholder="Type your message..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button id="send-btn" onclick="sendMessage()"><i data-lucide="send" size="20"></i></button>
    </div>
</div>

<script>
    let currentAudio = null;
    let audioQueue = [];
    let isSpeaking = false;

    lucide.createIcons();
    document.getElementById('api-key').value = localStorage.getItem('gemini_api_key') || '';

    window.onload = () => appendMessage('ai', "Welcome. Ensure your API key is set to start.");

    function toggleSettings() {
        const p = document.getElementById('settings-panel');
        p.style.display = p.style.display === 'block' ? 'none' : 'block';
    }

    function saveSettings() {
        localStorage.setItem('gemini_api_key', document.getElementById('api-key').value);
        localStorage.setItem('gemini_model', document.getElementById('model-select').value);
        toggleSettings();
    }

    function stopSpeech() {
        if (currentAudio) { currentAudio.pause(); currentAudio = null; }
        audioQueue = [];
        isSpeaking = false;
        document.querySelectorAll('.icon-btn').forEach(b => b.classList.remove('speaking'));
    }

    // --- SEQUENTIAL CHUNK TTS ---
    function speakInChunks(fullText, btn) {
        if (isSpeaking) { stopSpeech(); return; }
        
        stopSpeech(); // Clear any previous leftovers
        isSpeaking = true;
        btn.classList.add('speaking');

        // Split text into ~150 char chunks without breaking words
        const rawText = fullText.replace(/[*#_]/g, '');
        const chunks = [];
        let str = rawText;

        while (str.length > 0) {
            if (str.length <= 150) {
                chunks.push(str);
                break;
            }
            let cutPos = str.substring(0, 150).lastIndexOf(' ');
            if (cutPos <= 0) cutPos = 150; // Fallback if no space
            chunks.push(str.substring(0, cutPos));
            str = str.substring(cutPos).trim();
        }

        audioQueue = chunks;
        playNextInQueue(0, btn);
    }

    function playNextInQueue(index, btn) {
        if (!isSpeaking || index >= audioQueue.length) {
            stopSpeech();
            return;
        }

        const text = audioQueue[index];
        const url = `https://translate.google.com/translate_tts?ie=UTF-8&q=${encodeURIComponent(text)}&tl=en&client=tw-ob`;
        
        currentAudio = new Audio(url);
        currentAudio.play();
        
        currentAudio.onended = () => {
            playNextInQueue(index + 1, btn);
        };

        currentAudio.onerror = () => {
            console.error("TTS Error on chunk", index);
            playNextInQueue(index + 1, btn);
        };
    }

    async function sendMessage() {
        const input = document.getElementById('user-input');
        const apiKey = localStorage.getItem('gemini_api_key');
        const model = localStorage.getItem('gemini_model') || 'gemini-2.5-flash';
        const status = document.getElementById('ai-status');
        const text = input.value.trim();

        if (!text) return;
        if (!apiKey) { alert("Please set API Key."); toggleSettings(); return; }

        stopSpeech();
        appendMessage('user', text);
        input.value = '';
        status.style.display = 'block'; // Show "Thinking..."

        try {
            const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: text }] }] })
            });

            const data = await response.json();
            status.style.display = 'none';

            if (data.error) {
                // Show direct error message from Google
                appendMessage('error', `GOOGLE API ERROR: ${data.error.message} (Status: ${data.error.status})`);
            } else if (data.candidates) {
                appendMessage('ai', data.candidates[0].content.parts[0].text);
            }
        } catch (e) {
            status.style.display = 'none';
            appendMessage('error', `SERVER/NETWORK FAILURE: ${e.message}`);
        }
    }

    function appendMessage(sender, text) {
        const container = document.getElementById('messages');
        
        if (sender === 'error') {
            const errDiv = document.createElement('div');
            errDiv.className = 'error-box animate__animated animate__shakeX';
            errDiv.innerText = text;
            container.appendChild(errDiv);
        } else {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${sender}-wrapper animate__animated animate__fadeInUp`;

            const msgDiv = document.createElement('div');
            msgDiv.className = `message ${sender}`;
            msgDiv.innerHTML = text.replace(/\n/g, '<br>');
            wrapper.appendChild(msgDiv);

            if (sender === 'ai') {
                const btnArea = document.createElement('div');
                btnArea.className = 'action-btns';
                btnArea.innerHTML = `<button class="icon-btn"><i data-lucide="volume-2" size="18"></i></button>`;
                const btn = btnArea.querySelector('button');
                btn.onclick = () => speakInChunks(text, btn);
                wrapper.appendChild(btnArea);
            }
            container.appendChild(wrapper);
        }

        container.scrollTop = container.scrollHeight;
        lucide.createIcons();
    }
</script>
</body>
</html>
